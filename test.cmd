@echo off
chcp 65001 >nul
rem –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ —Å–∞—Ä–∫–∞—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –±–æ—Ç–∞
rem –ò—Å–ø–æ–ª—å–∑—É–µ—Ç uv –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏

echo.
echo ==========================================
echo   üß™ –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í –°–ê–†–ö–ê–°–¢–ò–ß–ï–°–ö–û–ì–û –ë–û–¢–ê
echo ==========================================
echo.

rem –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ uv —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
where uv >nul 2>nul
if %errorlevel% neq 0 (
    echo ‚ùå –û—à–∏–±–∫–∞: uv –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ
    echo –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ uv: https://docs.astral.sh/uv/getting-started/installation/
    echo.
    pause
    exit /b 1
)

rem –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ
echo üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º dev –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...
uv sync
if %errorlevel% neq 0 (
    echo ‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    pause
    exit /b 1
)

echo ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
echo.

rem –ó–∞–ø—É—Å–∫ –ª–∏–Ω—Ç–µ—Ä–æ–≤
echo üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞...
echo.

echo üìã Flake8 (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞):
uv run flake8 src tests --count --select=E9,F63,F7,F82 --show-source --statistics
if %errorlevel% neq 0 (
    echo ‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ
    pause
    exit /b 1
)

echo üîç MyPy (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤):
uv run mypy src --ignore-missing-imports
if %errorlevel% neq 0 (
    echo ‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π
    rem –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ –æ—à–∏–±–∫–∞—Ö mypy –¥–ª—è MVP
)

echo ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
echo.

rem –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
echo üß™ –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤...
echo.

uv run pytest tests/ -v --tb=short
set TEST_EXIT_CODE=%errorlevel%

echo.
if %TEST_EXIT_CODE% equ 0 (
    echo ‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–®–õ–ò –£–°–ü–ï–®–ù–û!
    echo.
    echo üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏...
    uv run pytest tests/ --cov=src --cov-report=term-missing --cov-report=html
    echo.
    echo üìà HTML –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ htmlcov/index.html
) else (
    echo ‚ùå –ù–ï–ö–û–¢–û–†–´–ï –¢–ï–°–¢–´ –ù–ï –ü–†–û–®–õ–ò
    echo –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
)

echo.
echo ==========================================
echo   üéØ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û  
echo ==========================================
echo.

pause
exit /b %TEST_EXIT_CODE%
